<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Language" content="mn">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OmniCredit — Зээлийн тооцоолуур</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/footer.css">

  <!-- Load navigation dependencies early -->
  <script src="js/utils.js" defer></script>
  <script src="js/api.js" defer></script>
  <script src="js/navigation.js" defer></script>
</head>

<style>
  /* ========= Reset-ish ========= */
*{ box-sizing:border-box; }

/* ========= HERO (inline байсан хэсэг) ========= */
.calc-hero{
  background:#103C4C;
  padding:40px;
  border-radius:var(--radius-lg);
  margin-top:16px;
  margin-bottom:24px;
}

.calc-hero__tagwrap{

  text-align:center;
  margin-bottom:4px;
}

.calc-hero__tag{
  display:inline-block;
  background:var(--bg);
  padding:6px 16px;
  border-radius:10px;
  font-size:12px;
  font-weight:700;
  color:#0d9488;
  letter-spacing:.5px;
  transform: translateY(-6px);
}

.calc-hero__title{
  margin:0;
  text-align:center;
  transform: translateY(-6px);
  font-size:32px;
  font-weight:800;
  color:#fff;
}

/* ========= Loan type row (inline байсан) ========= */
.loan-type-buttons{
  display:flex;
  gap:12px;
  margin-bottom:24px;
  justify-content:center;
  flex-wrap:wrap;
}

.loan-type-btn--link{
  text-decoration:none;
  display:inline-block;
}

/* ========= Range meta row (inline байсан) ========= */
.range-meta{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:#94a3b8;
  margin-top:6px;
}

/* ========= Promo row (inline байсан) ========= */
.promo-row{
  display:flex;
  gap:8px;
}

#promoCodeInput{
  flex:1;
  padding:12px 14px;
  border:1px solid #e5e7eb;
  border-radius:16px;
  font-size:14px;
  text-transform:uppercase;
}

#verifyPromoBtn{
  white-space:nowrap;
}

.promo-status{
  margin-top:8px;
  font-size:13px;
}

/* ========= Existing layout / styles (чи дээр байсан хэвээр) ========= */
body{
  margin:0;
  font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.info-tabs{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin:18px 0;
}

.info-tabs label{
  background:var(--card);
  border-radius:999px;
  box-shadow:var(--shadow);
  padding:14px 16px;
  text-align:center;
  font-weight:800;
  cursor:pointer;
  border:1px solid var(--line);
  user-select:none;
  color:var(--text);
}

input#i-cond:checked~.info-tabs label[for=i-cond],
input#i-req:checked~.info-tabs label[for=i-req],
input#i-faq:checked~.info-tabs label[for=i-faq]{
  background:var(--gradient-button2);
  color:var(--bg);
  border-color:transparent;
  font-weight:800;
}

.info-pane-wrap{
  border-radius:var(--radius-lg);
  overflow:hidden;
}

.pane{
  display:none;
  padding:16px 18px;
  background:#fff;
}

input#i-cond:checked~.info-pane-wrap #pane-conditions{ display:block; }
input#i-req:checked~.info-pane-wrap #pane-requirements{ display:block; }
input#i-faq:checked~.info-pane-wrap #pane-faq{ display:block; }

.pane h3{ margin:0 0 12px; }

.pane table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
}

.pane th{
  text-align:left;
  white-space:nowrap;
  padding-right:10px;
}

.grid{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:22px;
  margin-top:22px;
}

.card{
  background:var(--card);
  border-radius:var(--radius-lg);
  box-shadow:var(--shadow);
}

.pad{ padding:18px; }

.card h3{ margin:0 0 12px; }

.control{ margin-bottom:18px; }

.control label{
  display:block;
  font-weight:700;
  margin-bottom:6px;
}

.display{
  display:flex;
  align-items:center;
  gap:8px;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:12px 14px;
  box-shadow:0 6px 16px rgba(0,0,0,.06);
  font-weight:800;
}

.display input[type=number]{
  width:100%;
  background:transparent;
  border:none;
  font:inherit;
  color:#0ea5e9;
  outline:none;
  text-align:right;
  font-size:32px;
}

input[type=range]{
  width:100%;
  -webkit-appearance:none;
  height:6px;
  border-radius:999px;
  background:linear-gradient(90deg,#ede9fe,#e5e7eb);
}

input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:18px;
  height:18px;
  background:#14b8a6;
  border-radius:50%;
  box-shadow:0 0 0 3px #fff, 0 6px 16px rgba(0,0,0,.15);
  cursor:pointer;
}

.kpis-wide{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
  margin-top:14px;
}

.kpi{
  background:var(--gradient-peachy);
  color:white;
  border:none;
  border-radius:18px;
  padding:14px;
  text-align:center;
  box-shadow:var(--shadow);
}

.kpi b{
  display:block;
  font-size:20px;
  margin-top:4px;
  color:white;
  font-weight:800;
}

.chart-tabs{
  display:flex;
  gap:12px;
  margin-bottom:10px;
}

.chart-tabs label{
  padding:10px 14px;
  border-radius:999px;
  background:#fff;
  border:1px solid #e5e7eb;
  cursor:pointer;
  font-weight:800;
  color:var(--text);
  box-shadow:0 6px 14px rgba(0,0,0,.06);
}

input#c-pay:checked~.chart-tabs label[for=c-pay],
input#c-bal:checked~.chart-tabs label[for=c-bal]{
  background:var(--gradient-peachy);
  color:var(--text);
  border-color:transparent;
  box-shadow:0 10px 22px rgba(20,184,166,.28);
  font-weight:800;
}

.panel{ display:none; }
input#c-pay:checked~.panels #panel-pay{ display:block; }
input#c-bal:checked~.panels #panel-bal{ display:block; }

.chart-tip{
  position:fixed;
  z-index:50;
  pointer-events:none;
  background:#fff;
  border:1px solid #e5e7eb;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
  border-radius:12px;
  padding:10px 12px;
  min-width:180px;
  font:13px/1.35 'Inter',system-ui,sans-serif;
  color:#0f172a;
  transform:translate(-50%,-110%);
  display:none;
}

.chart-tip b{
  display:block;
  font-size:14px;
  margin-bottom:4px;
}

.chart-tip .row{
  display:flex;
  justify-content:space-between;
  gap:10px;
}

.chart-tip .v{
  font-weight:700;
  color:#1d4ed8;
}

/* ========= Responsive ========= */
@media(max-width:980px){
  .grid{ grid-template-columns:1fr; }
}

@media(max-width:768px){
  .page{ padding:12px; }

  .calc-hero{ padding:16px; }
  .calc-hero__title{ font-size:1.25rem; }

  .info-tabs{
    grid-template-columns:1fr;
    gap:8px;
  }

  .info-tabs label{
    padding:10px;
    font-size:.85rem;
  }

  .kpis-wide{
    grid-template-columns:1fr;
    gap:8px;
  }

  .kpi{
    padding:10px;
    font-size:.85rem;
  }

  .kpi b{
    font-size:1rem;
  }

  .card.pad{ padding:12px; }
  .card h3{ font-size:1rem; margin-bottom:10px; }
  .control{ margin-bottom:14px; }
  .control label{ font-size:.85rem; margin-bottom:4px; }

  .display{ padding:8px 10px; border-radius:12px; }
  .display input[type=number]{ font-size:1.25rem; }
  .display span{ font-size:.9rem; }

  input[type=range]{ height:8px; }
  input[type=range]::-webkit-slider-thumb{ width:22px; height:22px; }

  .chart-tabs{ flex-wrap:wrap; gap:8px; }
  .chart-tabs label{
    flex:1;
    min-width:100px;
    text-align:center;
    font-size:.8rem;
    padding:8px 10px;
  }

  .panels{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }

  .panel{ min-width:100%; }

  .panel canvas{
    width:100% !important;
    height:250px !important;
  }

  .loan-type-buttons{
    flex-direction:column !important;
  }

  .pane{ padding:12px; }
  .pane h3{ font-size:1rem; }

  .pane table{ font-size:.8rem; }
  .pane th, .pane td{ display:block; padding:2px 0; }
  .pane th{ font-weight:700; color:#064e3b; }

  .cta{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .cta .btn{
    width:100%;
    padding:12px 16px;
    font-size:.9rem;
  }
}

@media(max-width:480px){
  .page{ padding:10px; }
  .display input[type=number]{ font-size:1.1rem; }
  .panel canvas{ height:200px !important; }
  .kpi{ padding:8px; }
  .kpi b{ font-size:.95rem; }
  .info-tabs label{ padding:8px; font-size:.8rem; }
}

@media(max-width:360px){
  .display input[type=number]{ font-size:1rem; }
}

</style>
<body>

  <!-- NAV + PAGE WRAP -->
  <div class="container">
    <nav class="nav">
      <a href="index.html" class="brand">OmniCredit</a>
      <div class="nav-links">
        <a href="index.html">Нүүр</a>
        <a href="zeelhuudas.html" class="active">Зээлийн тооцоолуур</a>
        <a href="aboutus.html">Бидний тухай</a>
        <a href="FAQ.html">Түгээмэл асуулт</a>
      </div>
      <div class="auth-buttons">
        <a href="login.html" class="btn btn-ghost btn-sm">Нэвтрэх</a>
        <a href="register.html" class="btn btn-primary btn-sm">Бүртгүүлэх</a>
      </div>
      <button class="mobile-menu-toggle">☰</button>
    </nav>

    <!-- HERO -->
    <div class="calc-hero">
      <div class="calc-hero__tagwrap">
        <span class="calc-hero__tag">ТООЦООЛУУР</span>
      </div>
      <h2 class="calc-hero__title">Зээлийн нөхцөл харах ба баталгаажуулах</h2>
    </div>

    <!-- LOAN TYPE BUTTONS -->
    <div class="loan-type-buttons">
      <button class="btn btn-primary loan-type-btn active" data-type="consumer">
        Хэрэглээний зээл
      </button>
      <a href="purchase-loan.html" class="btn btn-secondary loan-type-btn loan-type-btn--link">
        Худалдан авалтын зээл
      </a>
    </div>

    <input type="radio" name="info" id="i-cond" checked hidden>
    <input type="radio" name="info" id="i-req" hidden>
    <input type="radio" name="info" id="i-faq" hidden>

    <div class="info-tabs">
      <label for="i-cond">Үйлчилгээний нөхцөл</label>
      <label for="i-req">Тавигдах шаардлага</label>
      <label for="i-faq">Түгээмэл асуулт</label>
    </div>

    <div class="card pad info-pane-wrap">
      <div class="pane" id="pane-conditions">
        <h3>Ерөнхий нөхцөл</h3>
        <table>
          <tr>
            <th>Зорилго</th>
            <td>Хэрэглээний зээл</td>
            <th>Хугацаа</th>
            <td>1–24 сар</td>
          </tr>
          <tr>
            <th>Хүү</th>
            <td>Сард 2% – 5%</td>
            <th>Барьцаа</th>
            <td>Шаардлагагүй</td>
          </tr>
          <tr>
            <th>Хязгаар</th>
            <td>₮10,000 – ₮3,000,000</td>
            <th>Хураамж</th>
            <td>0–1%</td>
          </tr>
        </table>
      </div>

      <div class="pane" id="pane-requirements">
        <h3>Тавигдах шаардлага</h3>
        <ul>
          <li>Монгол Улсын иргэн</li>
          <li>Тогтмол орлоготой</li>
          <li>Идэвхтэй банкны данстай</li>
        </ul>
      </div>

      <div class="pane" id="pane-faq">
        <h3>Түгээмэл асуулт</h3>
        <details>
          <summary>Урьдчилан төлбөл торгуультай юу?</summary>
          <div>Үгүй, хугацаанаас өмнө төлсөн тохиолдолд нэмэлт шимтгэлгүй.</div>
        </details>
        <details>
          <summary>Шийдвэр хэдий хугацаанд гарах вэ?</summary>
          <div>Урьдчилсан шийдвэр минутын дотор гарна.</div>
        </details>
      </div>
    </div>

    <section class="grid" id="calculator">
      <div class="card pad">
        <h3>Тохиргоо</h3>

        <div class="control">
          <label>Зээлийн дүн</label>
          <div class="display">
            <span>₮</span>
            <input id="amountNum" type="number" value="1500000" min="10000" max="3000000" step="10000" inputmode="numeric" />
          </div>
          <input id="amountRange" type="range" min="10000" max="3000000" step="10000" value="1500000" />
          <div class="range-meta">
            <span>₮10,000</span><span>₮3,000,000</span>
          </div>
        </div>

        <div class="control">
          <label>Сарын хүү (%)</label>
          <div class="display">
            <input id="rateNum" type="number" value="3" min="2" max="5" step="0.1" />
            <span>%</span>
          </div>
          <input id="rateRange" type="range" min="2" max="5" step="0.1" value="3" />
          <div class="range-meta">
            <span>2%</span><span>5%</span>
          </div>
        </div>

        <div class="control">
          <label>Зээлийн хугацаа (сар)</label>
          <div class="display">
            <input id="termNum" type="number" value="12" min="1" max="24" step="1" />
            <span>сар</span>
          </div>
          <input id="termRange" type="range" min="1" max="24" step="1" value="12" />
          <div class="range-meta">
            <span>1 сар</span><span>24 сар</span>
          </div>
        </div>

        <div class="control">
          <label>Нэмэгдлийн код (байгаа бол)</label>

          <div class="promo-row">
            <input id="promoCodeInput" type="text" placeholder="жнь: OMNI-ABC123" />
            <button type="button" id="verifyPromoBtn" class="btn btn-secondary">Шалгах</button>
          </div>

          <div id="promoCodeStatus" class="promo-status"></div>
        </div>

        <div class="cta">
          <button class="btn btn-primary" id="applyBtn">Хүсэлт илгээх</button>
          <button class="btn btn-ghost" id="pdfBtn">PDF хадгалах</button>
        </div>
      </div>

      <div class="card pad">
        <input type="radio" name="chart" id="c-pay" checked hidden>
        <input type="radio" name="chart" id="c-bal" hidden>

        <div class="chart-tabs">
          <label for="c-pay">Төлөлтийн график</label>
          <label for="c-bal">Үлдэгдлийн график</label>
        </div>

        <div class="panels">
          <div id="panel-pay" class="panel">
            <canvas id="paymentsChart" width="800" height="360"></canvas>
          </div>
          <div id="panel-bal" class="panel">
            <canvas id="balanceChart" width="800" height="360"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="kpis-wide">
      <div class="kpi">Сарын төлбөр<b id="kpiPayment">—</b></div>
      <div class="kpi">Нийт хүү<b id="kpiInterest">—</b></div>
      <div class="kpi">Нийт төлөх<b id="kpiTotal">—</b></div>
    </section>
  </div>

  <div id="chartTip" class="chart-tip"></div>

  <!-- ✅ YOUR JS (unchanged) -->
  <script>
    const fmt = new Intl.NumberFormat('mn-MN');
    const money = n => '₮' + fmt.format(Math.round(n || 0));
    const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

    function computeSchedule(P, ratePct, n) {
      P = Math.max(10000, +P || 0); n = Math.max(1, Math.floor(+n || 0));
      const r = (+ratePct || 0) / 100;
      let payment, bal = P, sch = [];
      if (r === 0) {
        payment = P / n;
        for (let m = 1; m <= n; m++) { const interest = 0, principal = payment; bal = Math.max(0, bal - principal); sch.push({ m, interest, principal, payment, bal }); }
      } else {
        payment = P * r / (1 - Math.pow(1 + r, -n));
        for (let m = 1; m <= n; m++) { const interest = bal * r, principal = Math.min(payment - interest, bal); bal = Math.max(0, bal - principal); sch.push({ m, interest, principal, payment, bal }); }
      }
      return {
        payment,
        totalInterest: sch.reduce((s, x) => s + x.interest, 0),
        totalPay: sch.reduce((s, x) => s + x.payment, 0),
        schedule: sch
      };
    }

    const amountNum = document.getElementById('amountNum'), amountRange = document.getElementById('amountRange');
    const rateNum = document.getElementById('rateNum'), rateRange = document.getElementById('rateRange');
    const termNum = document.getElementById('termNum'), termRange = document.getElementById('termRange');
    const kpiPayment = document.getElementById('kpiPayment'), kpiInterest = document.getElementById('kpiInterest'), kpiTotal = document.getElementById('kpiTotal');
    const paymentsCanvas = document.getElementById('paymentsChart'), balanceCanvas = document.getElementById('balanceChart');
    const tip = document.getElementById('chartTip');

    function bind(a, b, min, max) {
      const upd = v => { v = clamp(+v || 0, min, max); a.value = v; b.value = v; recalc(); };
      a.addEventListener('input', () => upd(a.value)); b.addEventListener('input', () => upd(b.value));
    }
    bind(amountNum, amountRange, 10000, 3000000);
    bind(rateNum, rateRange, 2, 5);
    bind(termNum, termRange, 1, 24);

    function clearCanvas(ctx) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height); }

    function drawPayments(schedule, hover = -1) {
      const ctx = paymentsCanvas.getContext('2d'); clearCanvas(ctx);
      const W = ctx.canvas.width, H = ctx.canvas.height, margin = 40, innerW = W - margin * 2, innerH = H - margin * 2;
      ctx.strokeStyle = '#e5e7eb'; ctx.setLineDash([4, 4]); ctx.strokeRect(margin, margin, innerW, innerH); ctx.setLineDash([]);

      const bars = Math.min(12, schedule.length), maxPay = Math.max(...schedule.map(s => s.payment));
      const slot = innerW / bars, bw = slot * 0.72, gap = slot * 0.28;
      ctx.font = '12px Inter, system-ui'; ctx.textAlign = 'center'; ctx.textBaseline = 'top';

      for (let i = 0; i < bars; i++) {
        const s = schedule[i], x = margin + i * slot + gap / 2, yB = H - margin;
        const totalH = innerH * (s.payment / maxPay), intH = innerH * (s.interest / maxPay), prinH = Math.max(0, totalH - intH);
        if (i === hover) { ctx.fillStyle = 'rgba(148,163,184,.35)'; ctx.fillRect(x - gap / 2, margin, bw + gap, innerH); }
        ctx.fillStyle = '#f59e0b'; ctx.fillRect(x, yB - intH, bw, intH);
        ctx.fillStyle = '#10b981'; ctx.fillRect(x, yB - intH - prinH, bw, prinH);
        ctx.fillStyle = '#4b5563'; ctx.fillText(`${i + 1}-р сар`, x + bw / 2, yB + 6);
      }
      ctx.fillStyle = '#111827'; ctx.textAlign = 'center'; ctx.textBaseline = 'alphabetic'; ctx.font = '16px Inter, system-ui'; ctx.fillText('Зээл төлөлтийн график', W / 2, 24);
      ctx.font = '12px Inter, system-ui'; ctx.textAlign = 'left';
      ctx.fillStyle = '#f59e0b'; ctx.fillRect(margin, margin - 14, 10, 10); ctx.fillStyle = '#111827'; ctx.fillText('Бодогдсон хүү', margin + 16, margin - 6);
      ctx.fillStyle = '#10b981'; ctx.fillRect(margin + 120, margin - 14, 10, 10); ctx.fillStyle = '#111827'; ctx.fillText('Үндсэн зээл', margin + 136, margin - 6);
      return { margin, slot, bars, innerW, innerH, bw, gap };
    }

    function drawBalance(schedule, P, hover = -1) {
      const ctx = balanceCanvas.getContext('2d'); clearCanvas(ctx);
      const W = ctx.canvas.width, H = ctx.canvas.height, margin = 40, innerW = W - margin * 2, innerH = H - margin * 2, n = schedule.length;
      ctx.strokeStyle = '#e5e7eb'; ctx.setLineDash([4, 4]); ctx.strokeRect(margin, margin, innerW, innerH); ctx.setLineDash([]);

      const pts = [];
      for (let i = 0; i < n; i++) { const x = margin + innerW * (i / (n - 1)), bal = P * (1 - i / (n - 1)), y = H - margin - innerH * (bal / P); pts.push([x, y, bal]); }

      ctx.beginPath(); ctx.moveTo(pts[0][0], pts[0][1]); for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
      ctx.lineTo(margin + innerW, H - margin); ctx.lineTo(margin, H - margin); ctx.closePath(); ctx.fillStyle = 'rgba(59,130,246,0.25)'; ctx.fill();
      ctx.beginPath(); ctx.moveTo(pts[0][0], pts[0][1]); for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();

      if (hover >= 0 && hover < pts.length) { const [x, y] = pts[hover]; ctx.strokeStyle = 'rgba(100,116,139,.7)'; ctx.beginPath(); ctx.moveTo(x, margin); ctx.lineTo(x, H - margin); ctx.stroke(); ctx.fillStyle = '#2563eb'; ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill(); }

      ctx.font = '12px Inter, system-ui'; ctx.fillStyle = '#4b5563'; ctx.textAlign = 'center';
      for (let i = 0; i < n; i++) { const x = margin + innerW * (i / (n - 1)); ctx.fillText(`${i + 1}-р сар`, x, H - margin + 6); }
      ctx.fillStyle = '#111827'; ctx.textAlign = 'center'; ctx.font = '16px Inter, system-ui'; ctx.fillText('Зээлийн үлдэгдлийн график', W / 2, 24);

      return { margin, innerW, pts };
    }

    let schedule = [], geomPay = null, geomBal = null;
    function recalc() {
      const P = +amountNum.value || 10000, r = +rateNum.value || 2, n = +termNum.value || 1;
      const res = computeSchedule(P, r, n); schedule = res.schedule;
      kpiPayment.textContent = money(res.payment);
      kpiInterest.textContent = money(res.totalInterest);
      kpiTotal.textContent = money(res.totalPay);
      geomPay = drawPayments(schedule, -1);
      geomBal = drawBalance(schedule, Math.max(P, 1), -1);
    }

    const showTip = (html, x, y) => { tip.innerHTML = html; tip.style.left = x + 'px'; tip.style.top = y + 'px'; tip.style.display = 'block'; };
    const hideTip = () => tip.style.display = 'none';

    paymentsCanvas.addEventListener('mousemove', e => {
      if (!geomPay) return; const rect = paymentsCanvas.getBoundingClientRect(), cx = (e.clientX - rect.left) * (paymentsCanvas.width / rect.width);
      const { margin, slot, bars } = geomPay; if (cx < margin || cx > (paymentsCanvas.width - margin)) { hideTip(); drawPayments(schedule, -1); return; }
      let idx = Math.floor((cx - margin) / slot); idx = Math.max(0, Math.min(bars - 1, idx));
      drawPayments(schedule, idx); const s = schedule[idx];
      showTip(`<b>${idx + 1}-р сар</b>
        <div class="row"><span>Үндсэн зээл:</span><span class="v">${money(s.principal)}</span></div>
        <div class="row"><span>Бодогдсон хүү:</span><span class="v">${money(s.interest)}</span></div>
        <div class="row"><span>Нийт төлбөр:</span><span class="v">${money(s.payment)}</span></div>`, e.clientX, e.clientY);
    });
    paymentsCanvas.addEventListener('mouseleave', () => { hideTip(); drawPayments(schedule, -1); });

    balanceCanvas.addEventListener('mousemove', e => {
      if (!geomBal) return; const rect = balanceCanvas.getBoundingClientRect(), cx = (e.clientX - rect.left) * (balanceCanvas.width / rect.width);
      const { margin, innerW, pts } = geomBal; if (cx < margin || cx > (balanceCanvas.width - margin)) { hideTip(); drawBalance(schedule, Math.max(+amountNum.value || 1, 1), -1); return; }
      let idx = Math.round(((cx - margin) / innerW) * (pts.length - 1)); idx = Math.max(0, Math.min(pts.length - 1, idx));
      drawBalance(schedule, Math.max(+amountNum.value || 1, 1), idx); const bal = pts[idx][2];
      showTip(`<b>${idx + 1}-р сар</b><div class="row"><span>Үлдэгдэл:</span><span class="v">${money(bal)}</span></div>`, e.clientX, e.clientY);
    });
    balanceCanvas.addEventListener('mouseleave', () => { hideTip(); drawBalance(schedule, Math.max(+amountNum.value || 1, 1), -1); });

    document.getElementById('pdfBtn').addEventListener('click', () => window.print());

    let verifiedPromoCode = null;

    document.getElementById('verifyPromoBtn').addEventListener('click', async () => {
      const promoInput = document.getElementById('promoCodeInput');
      const statusDiv = document.getElementById('promoCodeStatus');
      const code = promoInput.value.trim();

      if (!code) {
        statusDiv.innerHTML = '<span style="color: #f59e0b;">Код оруулна уу</span>';
        return;
      }

      if (!TokenManager.isAuthenticated()) {
        statusDiv.innerHTML = '<span style="color: #ef4444;">Код шалгахын тулд эхлээд нэвтэрнэ үү</span>';
        return;
      }

      statusDiv.innerHTML = '<span style="color: #64748b;">Шалгаж байна...</span>';

      try {
        const result = await PromoCodeAPI.verifyCode(code);

        if (result.valid) {
          verifiedPromoCode = result.promoCode;

          if (result.promoCode.interest_rate_override !== null) {
            rateNum.value = result.promoCode.interest_rate_override;
            rateRange.value = result.promoCode.interest_rate_override;
            recalc();
          }

          statusDiv.innerHTML = `
            <div style="background: #d1fae5; border-radius: 8px; padding: 10px; color: #065f46;">
              <strong>✓ Код хүчинтэй!</strong><br>
              <span style="font-size: 12px;">Компани: ${result.promoCode.company_name}</span><br>
              ${result.promoCode.interest_rate_override !== null ? `<span style="font-size: 12px;">Хүү: ${result.promoCode.interest_rate_override}%</span>` : ''}
            </div>
          `;
        } else {
          verifiedPromoCode = null;
          statusDiv.innerHTML = `<span style="color: #ef4444;">✗ ${result.error || 'Код хүчингүй'}</span>`;
        }
      } catch (error) {
        verifiedPromoCode = null;
        statusDiv.innerHTML = `<span style="color: #ef4444;">✗ ${error.message || 'Код шалгахад алдаа гарлаа'}</span>`;
      }
    });

    document.getElementById('promoCodeInput').addEventListener('input', () => {
      verifiedPromoCode = null;
      document.getElementById('promoCodeStatus').innerHTML = '';
    });

    document.getElementById('applyBtn').addEventListener('click', async () => {
      if (typeof TokenManager !== 'undefined' && !TokenManager.isAuthenticated()) {
        if (confirm('Зээл авахын тулд нэвтрэх хэрэгтэй. Нэвтрэх хуудас руу шилжих үү?')) {
          window.location.href = 'login.html';
        }
        return;
      }

      const amount = parseFloat(amountNum.value);
      const term = parseInt(termNum.value);
      const rate = parseFloat(rateNum.value);
      const promoCodeValue = document.getElementById('promoCodeInput').value.trim();

      if (isNaN(amount) || isNaN(term) || isNaN(rate)) {
        alert('Зээлийн төрөл, дүн, хугацаа оруулна уу');
        return;
      }

      if (amount < 10000 || amount > 3000000) {
        alert('Зээлийн дүн ₮10,000 - ₮3,000,000 хооронд байх ёстой');
        return;
      }

      if (term < 1 || term > 24) {
        alert('Хугацаа 1-24 сарын хооронд байх ёстой');
        return;
      }

      if (promoCodeValue && !verifiedPromoCode) {
        alert('Нэмэгдлийн кодыг эхлээд "Шалгах" товч дарж баталгаажуулна уу');
        return;
      }

      const confirmMsg = verifiedPromoCode
        ? `₮${fmt.format(amount)} зээлийн хүсэлт илгээх үү?\nХугацаа: ${term} сар\nХүү: ${rate}%\nНэмэгдлийн код: ${verifiedPromoCode.code} (${verifiedPromoCode.company_name})`
        : `₮${fmt.format(amount)} зээлийн хүсэлт илгээх үү?\nХугацаа: ${term} сар\nХүү: ${rate}%`;

      if (confirm(confirmMsg)) {
        try {
          const applyBtn = document.getElementById('applyBtn');
          applyBtn.disabled = true;
          applyBtn.textContent = 'Илгээж байна...';

          if (typeof LoansAPI !== 'undefined') {
            await LoansAPI.applyForLoan({
              amount: amount,
              duration_months: term,
              purpose: verifiedPromoCode
                ? `Хэрэглээний зээл - ${verifiedPromoCode.company_name} (${verifiedPromoCode.code})`
                : 'Хэрэглээний зээл - тооцоолуураас',
              monthly_income: 500000,
              occupation: 'Хэрэглэгч',
              promo_code: verifiedPromoCode ? verifiedPromoCode.code : null
            });

            if (typeof Utils !== 'undefined') {
              Utils.showToast('Амжилттай илгээлээ!', 'success');
            } else {
              alert('Амжилттай илгээлээ!');
            }

            setTimeout(() => {
              window.location.href = 'my-loans.html';
            }, 1500);
          } else {
            window.location.href = `Application.html?amount=${amount}&term=${term}`;
          }
        } catch (error) {
          console.error('Loan application error:', error);
          if (typeof Utils !== 'undefined') {
            Utils.showToast(error.message || 'Хүсэлт илгээхэд алдаа гарлаа', 'error');
          } else {
            alert('Хүсэлт илгээхэд алдаа гарлаа: ' + (error.message || ''));
          }

          const applyBtn = document.getElementById('applyBtn');
          applyBtn.disabled = false;
          applyBtn.textContent = 'Хүсэлт илгээх';
        }
      }
    });

    recalc();

    function resizeCanvases() {
      const container = document.querySelector('.panels');
      if (container && window.innerWidth <= 768) {
        const width = container.offsetWidth - 24;
        paymentsCanvas.style.width = width + 'px';
        balanceCanvas.style.width = width + 'px';
      }
    }

    window.addEventListener('resize', resizeCanvases);
    resizeCanvases();
  </script>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="footer-brand">OmniCredit</div>
          <p>Монголын хамгийн хялбар бөгөөд найдвартай зээлийн үйлчилгээ.</p>
        </div>
        <div class="footer-section">
          <h4>Үйлчилгээ</h4>
          <ul class="footer-links">
            <li><a href="zeelhuudas.html">Зээл авах</a></li>
            <li><a href="purchase-loan.html">Худалдан авалтын зээл</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Тусламж</h4>
          <ul class="footer-links">
            <li><a href="aboutus.html">Бидний тухай</a></li>
            <li><a href="FAQ.html">Түгээмэл асуулт</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="footer-copyright">
          <span>© 2025 OmniCredit. Бүх эрх хуулиар хамгаалагдсан.</span>
        </div>
      </div>
    </div>
  </footer>

  <script type="module" src="main.js"></script>
</body>
</html> 