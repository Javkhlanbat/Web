<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OmniCredit — Admin Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/footer.css">

  <style>
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 48px 0;
      margin: -32px 0 32px;
      color: white;
      text-align: center;
    }

    .admin-tabs {
      display: flex;
      gap: 8px;
      margin: 32px 0;
      border-bottom: 2px solid var(--line);
      overflow-x: auto;
    }

    .admin-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
      transition: var(--transition);
      white-space: nowrap;
    }

    .admin-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .admin-tab:hover {
      color: var(--text);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin: 32px 0;
    }

    .admin-stats-card {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    .admin-stats-card h3 {
      font-size: 2rem;
      margin: 8px 0;
      background: var(--gradient-peachy);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-stats-card p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .data-table {
      width: 100%;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: var(--bg);
      padding: 16px;
      text-align: left;
      font-weight: 700;
      font-size: 0.875rem;
      color: var(--text-muted);
      border-bottom: 2px solid var(--line);
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid var(--line);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover {
      background: var(--bg);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-pending {
      background: #FFF4E6;
      color: #F59E0B;
    }

    .status-approved {
      background: #DFFFD8;
      color: #10b981;
    }

    .status-rejected {
      background: #FFE6E6;
      color: #EF4444;
    }

    .status-active {
      background: #E0F2FE;
      color: #0284C7;
    }

    .status-disbursed {
      background: #D1FAE5;
      color: #059669;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      padding: 8px 12px;
      font-size: 0.875rem;
    }

    .search-box {
      margin: 24px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-box input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--line);
      border-radius: var(--radius);
      font-size: 1rem;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
    }

    @media (max-width: 768px) {
      .data-table {
        overflow-x: auto;
      }

      .admin-tabs {
        padding-bottom: 8px;
      }
    }

    /* User Profile Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius-lg);
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 24px;
    }

    .user-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .user-info-item {
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius);
    }

    .user-info-item label {
      font-size: 12px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    .user-info-item span {
      font-weight: 600;
      color: var(--text);
    }

    .id-images-section h3 {
      margin-bottom: 16px;
      color: var(--text);
    }

    .id-images-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .id-image-card {
      border: 2px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .id-image-card h4 {
      padding: 12px;
      background: var(--bg);
      margin: 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .id-image-card img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: #f5f5f5;
    }

    .id-image-card .no-image {
      width: 100%;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      background: #f5f5f5;
    }

    @media (max-width: 600px) {
      .user-info-grid,
      .id-images-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="brand">OmniCredit Admin</div>
      <div class="nav-links">
        <a href="index.html">Нүүр</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="admin.html" class="active">Admin</a>
      </div>
      <div class="auth-buttons">
        <a href="profile.html" class="btn btn-ghost btn-sm">Профайл</a>
        <button class="btn btn-primary btn-sm" onclick="handleLogout()">Гарах</button>
      </div>
      <button class="mobile-menu-toggle">☰</button>
    </nav>

    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <p style="opacity: 0.9; margin-top: 8px;">Системийн удирдлагын самбар</p>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="admin-stats-card">
        <p>Нийт хэрэглэгч</p>
        <h3 id="totalUsers">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>Хүлээгдэж буй хүсэлт</p>
        <h3 id="pendingLoans">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>Идэвхтэй зээл</p>
        <h3 id="activeLoans">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>Нийт зээлийн дүн</p>
        <h3 id="totalLoanAmount">₮0</h3>
      </div>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('loans')">Зээлийн хүсэлт</button>
      <button class="admin-tab" onclick="switchTab('users')">Хэрэглэгчид</button>
      <button class="admin-tab" onclick="switchTab('promo')">Компани & Код</button>
      <button class="admin-tab" onclick="switchTab('payments')">Төлбөр</button>
      <button class="admin-tab" onclick="switchTab('settings')">Тохиргоо</button>
    </div>

    <!-- Loans Tab -->
    <div id="loans-tab" class="tab-content active">
      <div class="search-box">
        <input type="text" placeholder="Хайх (ID, нэр, дүн)..." id="loanSearch" onkeyup="filterLoans()">
        <select class="btn btn-secondary" id="loanStatusFilter" onchange="filterLoans()">
          <option value="all">Бүх төлөв</option>
          <option value="pending">Хүлээгдэж буй</option>
          <option value="approved">Зөвшөөрөгдсөн</option>
          <option value="disbursed">Олгогдсон</option>
          <option value="rejected">Татгалзсан</option>
          <option value="active">Идэвхтэй</option>
        </select>
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Хэрэглэгч</th>
              <th>Дүн</th>
              <th>Хугацаа</th>
              <th>Төлөв</th>
              <th>Огноо</th>
              <th>Үйлдэл</th>
            </tr>
          </thead>
          <tbody id="loansTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
                Ачааллаж байна...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <div class="search-box">
        <input type="text" placeholder="Нэр, и-мэйл, утас, регистрээр хайх..." id="userSearch" onkeyup="filterUsers()">
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Нэр</th>
              <th>И-мэйл</th>
              <th>Утас</th>
              <th>Регистр</th>
              <th>Бүртгэсэн огноо</th>
              <th>Үйлдэл</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
                Ачааллаж байна...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Promo Tab (Компани & Код) -->
    <div id="promo-tab" class="tab-content">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Компаниуд -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">Компаниуд</h3>
            <button class="btn btn-primary btn-sm" onclick="showCreateCompanyModal()">+ Компани нэмэх</button>
          </div>
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Нэр</th>
                  <th>Төлөв</th>
                  <th>Үйлдэл</th>
                </tr>
              </thead>
              <tbody id="companiesTableBody">
                <tr>
                  <td colspan="4" style="text-align: center; padding: 32px; color: var(--text-muted);">
                    Ачааллаж байна...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Нэмэгдлийн кодууд -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">Нэмэгдлийн кодууд</h3>
            <button class="btn btn-primary btn-sm" onclick="showCreatePromoCodeModal()">+ Код үүсгэх</button>
          </div>
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>Код</th>
                  <th>Компани</th>
                  <th>Хүү</th>
                  <th>Ашигласан</th>
                  <th>Үйлдэл</th>
                </tr>
              </thead>
              <tbody id="promoCodesTableBody">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 32px; color: var(--text-muted);">
                    Ачааллаж байна...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="payments-tab" class="tab-content">
      <div class="search-box">
        <input type="text" placeholder="Төлбөр хайх..." id="paymentSearch" onkeyup="filterPayments()">
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Зээлийн ID</th>
              <th>Хэрэглэгч</th>
              <th>Дүн</th>
              <th>Огноо</th>
              <th>Төлөв</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
                Төлбөрийн түүх одоогоор байхгүй байна
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="card">
        <div class="card-body">
          <h3>Системийн тохиргоо</h3>
          <p style="color: var(--text-muted); margin: 16px 0;">Зээлийн үндсэн тохиргоо</p>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Хүүгийн хувь (%)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="1.5" value="1.5">
          </div>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Хамгийн их зээлийн дүн (₮)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="10000000" value="10000000">
          </div>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Хамгийн бага зээлийн дүн (₮)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="100000" value="100000">
          </div>

          <button class="btn btn-primary btn-lg" onclick="saveSettings()">Хадгалах</button>
        </div>
      </div>
    </div>

  </div>

  <!-- User Profile Modal -->
  <div id="userProfileModal" class="modal-overlay" onclick="closeUserModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Хэрэглэгчийн мэдээлэл</h2>
        <button class="modal-close" onclick="closeUserModal()">&times;</button>
      </div>
      <div class="modal-body" id="userProfileModalBody">
        <!-- User info will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Create Company Modal -->
  <div id="createCompanyModal" class="modal-overlay" onclick="closeCompanyModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Шинэ компани нэмэх</h2>
        <button class="modal-close" onclick="closeCompanyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="createCompanyForm" onsubmit="createCompany(event)">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Компанийн нэр *</label>
            <input type="text" id="companyName" required style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Тайлбар</label>
            <textarea id="companyDescription" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);"></textarea>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">И-мэйл</label>
            <input type="email" id="companyEmail" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Утас</label>
            <input type="text" id="companyPhone" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
          </div>
          <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">Компани үүсгэх</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Create Promo Code Modal -->
  <div id="createPromoCodeModal" class="modal-overlay" onclick="closePromoCodeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Шинэ нэмэгдлийн код үүсгэх</h2>
        <button class="modal-close" onclick="closePromoCodeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="createPromoCodeForm" onsubmit="createPromoCode(event)">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Компани *</label>
            <select id="promoCompanyId" required style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
              <option value="">-- Компани сонгох --</option>
            </select>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Код (хоосон үлдээвэл автоматаар үүснэ)</label>
            <input type="text" id="promoCode" placeholder="жнь: OMNI-ABC123" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius); text-transform: uppercase;">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Хүү (%) - энэ хүү ашиглагдана</label>
            <input type="number" id="promoInterestRate" step="0.1" min="0" max="10" value="2" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Дээд зээлийн дүн (₮)</label>
            <input type="number" id="promoMaxAmount" min="0" placeholder="Хязгааргүй" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Ашиглах дээд тоо</label>
            <input type="number" id="promoMaxUses" min="0" placeholder="Хязгааргүй" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Хүчинтэй огноо</label>
            <input type="date" id="promoExpiresAt" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Тайлбар</label>
            <textarea id="promoDescription" rows="2" style="width: 100%; padding: 12px; border: 2px solid var(--line); border-radius: var(--radius);"></textarea>
          </div>
          <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">Код үүсгэх</button>
        </form>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="footer-brand">OmniCredit</div>
          <p>Монголын хамгийн хялбар бөгөөд найдвартай зээлийн үйлчилгээ.</p>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="footer-copyright">
          <span>© 2025 OmniCredit. Бүх эрх хуулиар хамгаалагдсан.</span>
        </div>
      </div>
    </div>
  </footer>

<script src="js/navigation.js"></script>
<script src="js/auth-guard.js"></script>
  <script>
    let allLoans = [];
    let allUsers = [];
    let allPayments = [];

    // Logout handler
    function handleLogout() {
      if (confirm('Гарахдаа итгэлтэй байна уу?')) {
        AuthAPI.logout();
      }
    }

    // Tab switching
    function switchTab(tabName) {
      // Remove active class from all tabs
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active class from all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Add active class to clicked tab
      event.target.classList.add('active');

      // Show corresponding content
      document.getElementById(tabName + '-tab').classList.add('active');

      // Load data based on tab
      if (tabName === 'loans') loadLoans();
      else if (tabName === 'users') loadUsers();
      else if (tabName === 'promo') loadPromoData();
      else if (tabName === 'payments') loadPayments();
    }

    // Load statistics
    async function loadStatistics() {
      try {
        // Load all loans using LoansAPI
        const data = await LoansAPI.getAllLoans();
        const loans = data.loans || [];

        // Load all users using API
        const usersResponse = await api.get('/auth/admin/users');
        const users = usersResponse.users || [];

        // Calculate statistics
        const pendingLoans = loans.filter(l => l.status === 'pending').length;
        const activeLoans = loans.filter(l => l.status === 'active' || l.status === 'approved').length;
        const totalAmount = loans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);

        // Update UI
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('pendingLoans').textContent = pendingLoans;
        document.getElementById('activeLoans').textContent = activeLoans;
        document.getElementById('totalLoanAmount').textContent = `₮${totalAmount.toLocaleString()}`;

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Load loans
    async function loadLoans() {
      try {
        const data = await LoansAPI.getAllLoans();
        allLoans = data.loans || [];
        displayLoans(allLoans);
      } catch (error) {
        console.error('Error loading loans:', error);
        document.getElementById('loansTableBody').innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: #EF4444;">
              Алдаа гарлаа: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display loans
    function displayLoans(loans) {
      const tbody = document.getElementById('loansTableBody');

      if (!loans || loans.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
              Зээлийн хүсэлт байхгүй байна
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = loans.map(loan => {
        const statusClass = `status-${loan.status}`;
        const statusText = {
          'pending': 'Хүлээгдэж буй',
          'approved': 'Зөвшөөрөгдсөн',
          'rejected': 'Татгалзсан',
          'active': 'Идэвхтэй',
          'disbursed': 'Олгогдсон'
        }[loan.status] || loan.status;

        const date = new Date(loan.created_at).toLocaleDateString('mn-MN');
        const amount = parseFloat(loan.amount) || 0;

        // Товчны логик: pending -> Зөвшөөрөх/Татгалзах, бусад -> Харах
        // Зөвшөөрөхөд шууд wallet-д мөнгө орно
        let actionButtons = '';
        if (loan.status === 'pending') {
          actionButtons = `
            <button class="btn btn-primary btn-icon" onclick="approveLoan(${loan.id})">Зөвшөөрөх</button>
            <button class="btn btn-secondary btn-icon" onclick="rejectLoan(${loan.id})">Татгалзах</button>
          `;
        } else {
          actionButtons = `
            <button class="btn btn-secondary btn-icon" onclick="viewLoanDetails(${loan.id})">Харах</button>
          `;
        }

        return `
          <tr>
            <td>#${loan.id}</td>
            <td>${loan.first_name || ''} ${loan.last_name || ''} (${loan.email || loan.user_id})</td>
            <td style="font-weight: 700;">₮${amount.toLocaleString()}</td>
            <td>${loan.term_months} сар</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${date}</td>
            <td>
              <div class="action-buttons">
                ${actionButtons}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filter loans
    function filterLoans() {
      const searchTerm = document.getElementById('loanSearch').value.toLowerCase();
      const statusFilter = document.getElementById('loanStatusFilter').value;

      let filtered = allLoans;

      // Filter by status
      if (statusFilter !== 'all') {
        filtered = filtered.filter(loan => loan.status === statusFilter);
      }

      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(loan =>
          loan.id.toString().includes(searchTerm) ||
          loan.user_id.toString().includes(searchTerm) ||
          loan.amount.toString().includes(searchTerm)
        );
      }

      displayLoans(filtered);
    }

    // Approve loan - зөвшөөрөхөд шууд wallet-д мөнгө орно
    async function approveLoan(loanId) {
      if (!confirm('Энэ зээлийг зөвшөөрөх үү?\n\nЗөвшөөрсний дараа хэрэглэгчийн wallet-д шууд мөнгө орно.')) return;

      try {
        const result = await LoansAPI.updateLoanStatus(loanId, 'approved');
        alert(`Зээл зөвшөөрөгдөж, хэрэглэгчийн wallet-д шилжүүлэгдлээ!\n\nДүн: ₮${result.disbursement?.amount?.toLocaleString() || ''}`);
        loadLoans();
        loadStatistics();
      } catch (error) {
        console.error('Error approving loan:', error);
        alert('Алдаа гарлаа: ' + error.message);
      }
    }

    // Reject loan
    async function rejectLoan(loanId) {
      if (!confirm('Энэ зээлийг татгалзах уу?')) return;

      try {
        await LoansAPI.updateLoanStatus(loanId, 'rejected');
        alert('Зээл татгалзагдлаа');
        loadLoans();
        loadStatistics();
      } catch (error) {
        console.error('Error rejecting loan:', error);
        alert('Алдаа гарлаа: ' + error.message);
      }
    }

    // Disburse loan - зээл олгох
    async function disburseLoan(loanId) {
      if (!confirm('Энэ зээлийг олгох уу?\n\nЗээлийн дүн хэрэглэгчийн дансанд шилжүүлэгдэнэ.')) return;

      try {
        const result = await LoansAPI.disburseLoan(loanId);
        alert(`Зээл амжилттай олгогдлоо!\n\nДүн: ₮${result.disbursement.amount.toLocaleString()}\nХэрэглэгч ID: ${result.disbursement.recipient_user_id}`);
        loadLoans();
        loadStatistics();
      } catch (error) {
        console.error('Error disbursing loan:', error);
        alert('Алдаа гарлаа: ' + error.message);
      }
    }

    // View loan details
    function viewLoanDetails(loanId) {
      alert(`Зээлийн дэлгэрэнгүй мэдээлэл #${loanId}\n\nЭнэ функц удахгүй нэмэгдэнэ.`);
    }

    // Load users
    async function loadUsers() {
      try {
        const data = await api.get('/auth/admin/users');
        console.log('Users loaded:', data.users?.length || 0);
        allUsers = data.users || [];
        displayUsers(allUsers);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: #EF4444;">
              Алдаа гарлаа: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display users
    function displayUsers(users) {
      const tbody = document.getElementById('usersTableBody');

      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
              Хэрэглэгч байхгүй байна
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => {
        const date = new Date(user.created_at).toLocaleDateString('mn-MN');
        const fullName = `${user.last_name || ''} ${user.first_name || ''}`.trim() || '-';
        const isCurrentUser = user.id === UserManager.getUser()?.id;
        const isAdminUser = user.is_admin;

        return `
          <tr>
            <td>#${user.id}</td>
            <td style="font-weight: 600;">
              ${fullName}
              ${isAdminUser ? '<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px;">ADMIN</span>' : ''}
            </td>
            <td>${user.email}</td>
            <td>${user.phone || '-'}</td>
            <td>${user.register_number || '-'}</td>
            <td>${date}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-secondary btn-icon" onclick="viewUserProfile(${user.id}, '${user.email}')">Profile</button>
                ${!isCurrentUser ? `<button class="btn btn-secondary btn-icon" style="background: #EF4444; border-color: #EF4444;" onclick="deleteUser(${user.id}, '${fullName}')">Delete</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filter users
    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase().trim();

      if (!searchTerm) {
        displayUsers(allUsers);
        return;
      }

      const filtered = allUsers.filter(user => {
        const fullName = `${user.last_name || ''} ${user.first_name || ''}`.toLowerCase();
        const email = (user.email || '').toLowerCase();
        const phone = (user.phone || '').toLowerCase();
        const register = (user.register_number || '').toLowerCase();

        return user.id.toString().includes(searchTerm) ||
               fullName.includes(searchTerm) ||
               email.includes(searchTerm) ||
               phone.includes(searchTerm) ||
               register.includes(searchTerm);
      });

      displayUsers(filtered);
    }

    // View user profile modal with ID card images
    async function viewUserProfile(userId, userEmail) {
      const modalBody = document.getElementById('userProfileModalBody');
      modalBody.innerHTML = '<p style="text-align: center; padding: 40px;">Ачааллаж байна...</p>';
      document.getElementById('userProfileModal').classList.add('active');
      document.body.style.overflow = 'hidden';

      try {
        const response = await AuthAPI.getAdminUserDetails(userId);
        const user = response.user;

        if (user) {
          const fullName = `${user.last_name || ''} ${user.first_name || ''}`.trim() || '-';
          const createdDate = new Date(user.created_at).toLocaleString('mn-MN');

          modalBody.innerHTML = `
            <div class="user-info-grid">
              <div class="user-info-item">
                <label>Бүтэн нэр</label>
                <span>${fullName}</span>
              </div>
              <div class="user-info-item">
                <label>И-мэйл</label>
                <span>${user.email || '-'}</span>
              </div>
              <div class="user-info-item">
                <label>Утасны дугаар</label>
                <span>${user.phone || '-'}</span>
              </div>
              <div class="user-info-item">
                <label>Регистрийн дугаар</label>
                <span>${user.register_number || '-'}</span>
              </div>
              <div class="user-info-item">
                <label>Бүртгүүлсэн огноо</label>
                <span>${createdDate}</span>
              </div>
              <div class="user-info-item">
                <label>Админ эрх</label>
                <span>${user.is_admin ? 'Тийм' : 'Үгүй'}</span>
              </div>
            </div>

            <div class="id-images-section">
              <h3>Иргэний үнэмлэхний зурагнууд</h3>
              <div class="id-images-grid">
                <div class="id-image-card">
                  <h4>Урд тал</h4>
                  ${user.id_front
                    ? `<img src="${user.id_front}" alt="ID Front" onclick="openImageInNewTab('${user.id_front}')" style="cursor: pointer;" title="Томруулахын тулд дарна уу">`
                    : '<div class="no-image">Зураг байхгүй</div>'}
                </div>
                <div class="id-image-card">
                  <h4>Ард тал</h4>
                  ${user.id_back
                    ? `<img src="${user.id_back}" alt="ID Back" onclick="openImageInNewTab('${user.id_back}')" style="cursor: pointer;" title="Томруулахын тулд дарна уу">`
                    : '<div class="no-image">Зураг байхгүй</div>'}
                </div>
              </div>
            </div>
          `;
        } else {
          modalBody.innerHTML = '<p style="text-align: center; padding: 40px; color: #EF4444;">Хэрэглэгч олдсонгүй</p>';
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        modalBody.innerHTML = `<p style="text-align: center; padding: 40px; color: #EF4444;">Алдаа: ${error.message}</p>`;
      }
    }

    // Close user profile modal
    function closeUserModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('userProfileModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Open image in new tab
    function openImageInNewTab(imageSrc) {
      const newWindow = window.open();
      newWindow.document.write(`<img src="${imageSrc}" style="max-width: 100%; height: auto;">`);
    }

    // Delete user
    async function deleteUser(userId, userName) {
      if (!confirm(`Та "${userName}" хэрэглэгчийг устгахдаа итгэлтэй байна уу?\n\nЭнэ үйлдлийг буцаах боломжгүй!`)) {
        return;
      }

      try {
        await api.delete(`/auth/admin/users/${userId}`);
        Utils.showToast(`${userName} амжилттай устгагдлаа`, 'success');

        // Жагсаалтыг дахин ачаалах
        await loadUsers();
        await loadStatistics();

      } catch (error) {
        console.error('Error deleting user:', error);
        Utils.showToast('Алдаа: ' + error.message, 'error');
      }
    }

    // Load payments
    function loadPayments() {
      // Placeholder - will be implemented when payment API is ready
      document.getElementById('paymentsTableBody').innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
            Төлбөрийн түүх одоогоор байхгүй байна
          </td>
        </tr>
      `;
    }

    // Filter payments
    function filterPayments() {
      // Placeholder
    }

    // Save settings
    function saveSettings() {
      alert('Тохиргоо хадгалагдлаа!\n\nЭнэ функц удахгүй бүрэн ажиллах болно.');
    }

    // ==========================================
    // КОМПАНИ & НЭМЭГДЛИЙН КОД ФУНКЦУУД
    // ==========================================

    let allCompanies = [];
    let allPromoCodes = [];

    // Load companies
    async function loadCompanies() {
      try {
        const data = await PromoCodeAPI.getAllCompanies();
        allCompanies = data.companies || [];
        displayCompanies(allCompanies);
        // Promo код үүсгэх modal-д компаниуд нэмэх
        updateCompanySelect();
      } catch (error) {
        console.error('Error loading companies:', error);
        document.getElementById('companiesTableBody').innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 32px; color: #EF4444;">
              Алдаа: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display companies
    function displayCompanies(companies) {
      const tbody = document.getElementById('companiesTableBody');

      if (!companies || companies.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 32px; color: var(--text-muted);">
              Компани байхгүй байна
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = companies.map(company => `
        <tr>
          <td>#${company.id}</td>
          <td style="font-weight: 600;">${company.name}</td>
          <td>
            <span class="status-badge ${company.is_active ? 'status-approved' : 'status-rejected'}">
              ${company.is_active ? 'Идэвхтэй' : 'Идэвхгүй'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-secondary btn-icon" onclick="toggleCompanyStatus(${company.id}, ${!company.is_active})">
                ${company.is_active ? 'Идэвхгүй' : 'Идэвхжүүлэх'}
              </button>
              <button class="btn btn-secondary btn-icon" style="background: #EF4444; border-color: #EF4444;" onclick="deleteCompany(${company.id})">Устгах</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Update company select dropdown
    function updateCompanySelect() {
      const select = document.getElementById('promoCompanyId');
      select.innerHTML = '<option value="">-- Компани сонгох --</option>' +
        allCompanies.filter(c => c.is_active).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    // Load promo codes
    async function loadPromoCodes() {
      try {
        const data = await PromoCodeAPI.getAllPromoCodes();
        allPromoCodes = data.promoCodes || [];
        displayPromoCodes(allPromoCodes);
      } catch (error) {
        console.error('Error loading promo codes:', error);
        document.getElementById('promoCodesTableBody').innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 32px; color: #EF4444;">
              Алдаа: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display promo codes
    function displayPromoCodes(codes) {
      const tbody = document.getElementById('promoCodesTableBody');

      if (!codes || codes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 32px; color: var(--text-muted);">
              Нэмэгдлийн код байхгүй байна
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = codes.map(code => `
        <tr>
          <td style="font-weight: 700; font-family: monospace; color: #0ea5e9;">${code.code}</td>
          <td>${code.company_name || '-'}</td>
          <td>${code.interest_rate_override !== null ? code.interest_rate_override + '%' : '-'}</td>
          <td>${code.used_count || 0}${code.max_uses ? '/' + code.max_uses : ''}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-secondary btn-icon" onclick="copyCode('${code.code}')">Copy</button>
              <button class="btn btn-secondary btn-icon" style="background: #EF4444; border-color: #EF4444;" onclick="deletePromoCode(${code.id})">Устгах</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Show create company modal
    function showCreateCompanyModal() {
      document.getElementById('createCompanyModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Close company modal
    function closeCompanyModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('createCompanyModal').classList.remove('active');
      document.body.style.overflow = '';
      document.getElementById('createCompanyForm').reset();
    }

    // Create company
    async function createCompany(event) {
      event.preventDefault();

      const companyData = {
        name: document.getElementById('companyName').value,
        description: document.getElementById('companyDescription').value,
        contact_email: document.getElementById('companyEmail').value,
        contact_phone: document.getElementById('companyPhone').value
      };

      try {
        await PromoCodeAPI.createCompany(companyData);
        Utils.showToast('Компани амжилттай үүсгэгдлээ', 'success');
        closeCompanyModal();
        loadCompanies();
      } catch (error) {
        console.error('Error creating company:', error);
        Utils.showToast('Алдаа: ' + error.message, 'error');
      }
    }

    // Toggle company status
    async function toggleCompanyStatus(companyId, newStatus) {
      try {
        await PromoCodeAPI.updateCompany(companyId, { is_active: newStatus });
        Utils.showToast('Компанийн төлөв шинэчлэгдлээ', 'success');
        loadCompanies();
      } catch (error) {
        console.error('Error updating company:', error);
        Utils.showToast('Алдаа: ' + error.message, 'error');
      }
    }

    // Delete company
    async function deleteCompany(companyId) {
      if (!confirm('Компанийг устгах уу? Түүнтэй холбоотой бүх код устана!')) return;

      try {
        await PromoCodeAPI.deleteCompany(companyId);
        Utils.showToast('Компани устгагдлаа', 'success');
        loadCompanies();
        loadPromoCodes();
      } catch (error) {
        console.error('Error deleting company:', error);
        Utils.showToast('Алдаа: ' + error.message, 'error');
      }
    }

    // Show create promo code modal
    function showCreatePromoCodeModal() {
      if (allCompanies.filter(c => c.is_active).length === 0) {
        alert('Эхлээд нэг компани үүсгэнэ үү!');
        return;
      }
      document.getElementById('createPromoCodeModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Close promo code modal
    function closePromoCodeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('createPromoCodeModal').classList.remove('active');
      document.body.style.overflow = '';
      document.getElementById('createPromoCodeForm').reset();
    }

    // Create promo code
    async function createPromoCode(event) {
      event.preventDefault();

      const expiresAt = document.getElementById('promoExpiresAt').value;

      const promoData = {
        company_id: document.getElementById('promoCompanyId').value,
        code: document.getElementById('promoCode').value || undefined,
        interest_rate_override: parseFloat(document.getElementById('promoInterestRate').value) || null,
        max_loan_amount: parseInt(document.getElementById('promoMaxAmount').value) || null,
        max_uses: parseInt(document.getElementById('promoMaxUses').value) || null,
        expires_at: expiresAt ? new Date(expiresAt).toISOString() : null,
        description: document.getElementById('promoDescription').value
      };

      try {
        const result = await PromoCodeAPI.createPromoCode(promoData);
        Utils.showToast(`Код үүсгэгдлээ: ${result.promoCode.code}`, 'success');
        closePromoCodeModal();
        loadPromoCodes();
      } catch (error) {
        console.error('Error creating promo code:', error);
        Utils.showToast('Алдаа: ' + error.message, 'error');
      }
    }

    // Delete promo code
    async function deletePromoCode(codeId) {
      if (!confirm('Энэ кодыг устгах уу?')) return;

      try {
        await PromoCodeAPI.deletePromoCode(codeId);
        Utils.showToast('Код устгагдлаа', 'success');
        loadPromoCodes();
      } catch (error) {
        console.error('Error deleting promo code:', error);
        Utils.showToast('Алдаа: ' + error.message, 'error');
      }
    }

    // Copy code to clipboard
    function copyCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        Utils.showToast(`"${code}" хуулагдлаа`, 'success');
      }).catch(() => {
        Utils.showToast('Хуулахад алдаа гарлаа', 'error');
      });
    }

    // Load promo tab data
    function loadPromoData() {
      loadCompanies();
      loadPromoCodes();
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadStatistics();
        loadLoans();
      });
    } else {
      loadStatistics();
      loadLoans();
    }
  </script>
  <!-- Main Application - Component Based -->
  <script type="module" src="main.js"></script>
</body>
</html>
