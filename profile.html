<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OmniCredit — Хувийн мэдээлэл</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/footer.css">

  <style>
    .profile-container {
      max-width: 900px;
      margin: 48px auto 80px;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 48px;
      padding: 32px;
      background: var(--gradient-soft);
      border-radius: var(--radius-lg);
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--gradient-peachy);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
      font-weight: 800;
      flex-shrink: 0;
      position: relative;
      cursor: pointer;
      overflow: hidden;
      transition: var(--transition);
    }

    .profile-avatar:hover {
      transform: scale(1.05);
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-upload-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      text-align: center;
      padding: 4px;
      font-size: 10px;
      opacity: 0;
      transition: var(--transition);
    }

    .profile-avatar:hover .avatar-upload-overlay {
      opacity: 1;
    }

    #avatarInput {
      display: none;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
      border-bottom: 2px solid var(--line);
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 700;
      color: var(--text-muted);
      transition: var(--transition);
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .tabs {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html" class="brand">OmniCredit</a>
      <div class="nav-links">
        <a href="index.html">Нүүр</a>
        <a href="zeelhuudas.html">Зээлийн тооцоолуур</a>
        <a href="aboutus.html">Бидний тухай</a>
        <a href="FAQ.html">Түгээмэл асуулт</a>
        <a href="my-loans.html">Миний зээл</a>
      </div>
      <div class="auth-buttons">
        <a href="dashboard.html" class="btn btn-primary btn-sm">Dashboard</a>
        <button class="btn btn-ghost btn-sm" onclick="handleLogout()">Гарах</button>
      </div>
      <button class="mobile-menu-toggle">☰</button>
    </nav>

    <div class="profile-container">
      <div class="profile-header">
        <div class="profile-avatar" id="userAvatar" onclick="document.getElementById('avatarInput').click()">
          <span id="avatarInitials">--</span>
          <div class="avatar-upload-overlay">Зураг солих</div>
        </div>
        <input type="file" id="avatarInput" accept="image/*">
        <div>
          <h1 style="margin-bottom: 8px;" id="userName">Уншиж байна...</h1>
          <p style="color: var(--text-muted); margin-bottom: 12px;" id="userEmail">--</p>
          <span style="padding: 6px 12px; background: white; border-radius: 999px; font-size: 12px; font-weight: 700; color: var(--primary);">
            Баталгаажсан
          </span>
        </div>
      </div>

      <!-- Quick Stats -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">
        <div class="card" style="text-align: center; padding: 24px;">
          <div style="font-size: 32px; margin-bottom: 8px;"></div>
          <div id="walletBalanceStat" style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">₮0</div>
          <div style="font-size: 13px; color: var(--text-muted);">Wallet үлдэгдэл</div>
        </div>
        <div class="card" style="text-align: center; padding: 24px;">
          <div style="font-size: 32px; margin-bottom: 8px;"></div>
          <div id="activeLoansCount" style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">0</div>
          <div style="font-size: 13px; color: var(--text-muted);">Идэвхтэй зээл</div>
        </div>
        <div class="card" style="text-align: center; padding: 24px;">
          <div style="font-size: 32px; margin-bottom: 8px;"></div>
          <div id="totalLoanAmount" style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">₮0</div>
          <div style="font-size: 13px; color: var(--text-muted);">Нийт зээлийн дүн</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="personal">Хувийн мэдээлэл</button>
        <button class="tab" data-tab="wallet">Wallet</button>
        <button class="tab" data-tab="security">Нууцлал</button>
        <button class="tab" data-tab="preferences">Тохиргоо</button>
      </div>

      
      <div class="tab-content active" id="personal">
        <div class="card">
          <div class="card-header">
            <h3>Хувийн мэдээлэл</h3>
          </div>
          <div class="card-body">
            <form id="profileForm">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Овог</label>
                  <input type="text" id="lastName" class="form-control" value="">
                </div>
                <div class="form-group">
                  <label class="form-label">Нэр</label>
                  <input type="text" id="firstName" class="form-control" value="">
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Имэйл хаяг</label>
                <input type="email" id="email" class="form-control" value="" readonly>
              </div>

              <div class="form-group">
                <label class="form-label">Утасны дугаар</label>
                <input type="tel" id="phone" class="form-control" value="">
              </div>

              <div class="form-group">
                <label class="form-label">Регистр</label>
                <input type="text" id="registerId" class="form-control" value="" disabled>
              </div>

              <button type="submit" class="btn btn-primary">Хадгалах</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Wallet Tab -->
      <div class="tab-content" id="wallet">
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 24px;">
          <div class="card-body" style="padding: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px;">
              <div>
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 8px; font-size: 14px;">Миний Wallet үлдэгдэл</p>
                <h2 id="walletBalanceMain" style="color: white; font-size: 2.5rem; margin: 0;">₮0</h2>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="dashboard.html" class="btn" style="background: rgba(255,255,255,0.2); border: none; color: white;">
                  Dashboard руу
                </a>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Сүүлийн гүйлгээ</h3>
          </div>
          <div class="card-body" id="walletTransactions">
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <p>Уншиж байна...</p>
            </div>
          </div>
        </div>
      </div>


      <div class="tab-content" id="security">
        <div class="card">
          <div class="card-header">
            <h3>Нууц үг солих</h3>
          </div>
          <div class="card-body">
            <form>
              <div class="form-group">
                <label class="form-label">Одоогийн нууц үг</label>
                <input type="password" class="form-control" placeholder="••••••••">
              </div>

              <div class="form-group">
                <label class="form-label">Шинэ нууц үг</label>
                <input type="password" class="form-control" placeholder="••••••••">
              </div>

              <div class="form-group">
                <label class="form-label">Шинэ нууц үг давтах</label>
                <input type="password" class="form-control" placeholder="••••••••">
              </div>

              <button type="submit" class="btn btn-primary">Солих</button>
            </form>
          </div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <h3>Хоёр хүчин зүйлийн баталгаажуулалт</h3>
          </div>
          <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4 style="margin-bottom: 4px;">SMS баталгаажуулалт</h4>
                <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                  Нэвтрэх үед SMS код шаардах
                </p>
              </div>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" style="margin-right: 8px;">
                <span>Идэвхжүүлэх</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      
      <div class="tab-content" id="preferences">
        <div class="card">
          <div class="card-header">
            <h3>Мэдэгдлийн тохиргоо</h3>
          </div>
          <div class="card-body">
            <div style="padding: 16px 0; border-bottom: 1px solid var(--line);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4 style="margin-bottom: 4px;">Имэйл мэдэгдэл</h4>
                  <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                    Төлбөрийн сануулга, шинэ санал
                  </p>
                </div>
                <input type="checkbox" checked>
              </div>
            </div>

            <div style="padding: 16px 0; border-bottom: 1px solid var(--line);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4 style="margin-bottom: 4px;">SMS мэдэгдэл</h4>
                  <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                    Төлбөрийн сануулга, хүлээн авалт
                  </p>
                </div>
                <input type="checkbox" checked>
              </div>
            </div>

            <div style="padding: 16px 0;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4 style="margin-bottom: 4px;">Маркетингийн мэдээлэл</h4>
                  <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                    Хөнгөлөлт, урамшуулал
                  </p>
                </div>
                <input type="checkbox">
              </div>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: 16px;">Хадгалах</button>
          </div>
        </div>

        <div class="card" style="margin-top: 24px; border: 2px solid #FFE5E5;">
          <div class="card-body">
            <h4 style="color: #EF4444; margin-bottom: 12px;">Данс устгах</h4>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 16px;">
              Таны бүх мэдээлэл устгагдах бөгөөд энэ үйлдлийг буцаах боломжгүй.
            </p>
            <button class="btn btn-ghost" style="border-color: #EF4444; color: #EF4444;">
              Данс устгах
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="footer-brand">OmniCredit</div>
          <p>Монголын хамгийн хялбар бөгөөд найдвартай зээлийн үйлчилгээ.</p>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="footer-copyright">
          <span>© 2025 OmniCredit. Бүх эрх хуулиар хамгаалагдсан.</span>
        </div>
      </div>
    </div>
  </footer>

  <script src="js/utils.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth-guard.js"></script>
  <script>
    function handleLogout() {
      if (confirm('Гарахдаа итгэлтэй байна уу?')) {
        AuthAPI.logout();
      }
    }

    // Load user profile
    async function loadProfile() {
      try {
        const profile = await AuthAPI.getProfile();

        if (profile) {
          // Update header
          const firstName = profile.first_name || '';
          const lastName = profile.last_name || '';
          const fullName = `${lastName} ${firstName}`.trim();

          document.getElementById('userName').textContent = fullName || 'Хэрэглэгч';
          document.getElementById('userEmail').textContent = profile.email || '';

          // Avatar initials or image
          const initials = (lastName.charAt(0) + firstName.charAt(0)).toUpperCase() || 'XX';
          const avatarInitialsElement = document.getElementById('avatarInitials');

          // Check if user has profile image from database
          if (profile.profile_image) {
            // Display saved avatar image from database
            const avatarContainer = document.getElementById('userAvatar');
            avatarContainer.style.background = 'none';
            avatarInitialsElement.style.display = 'none';

            const img = document.createElement('img');
            img.src = profile.profile_image;
            img.alt = 'Profile Avatar';
            avatarContainer.insertBefore(img, avatarContainer.firstChild);
          } else {
            avatarInitialsElement.textContent = initials;
          }

          // Update form fields
          document.getElementById('firstName').value = firstName;
          document.getElementById('lastName').value = lastName;
          document.getElementById('email').value = profile.email || '';
          document.getElementById('phone').value = profile.phone || '';
          document.getElementById('registerId').value = profile.register_number || '';
        }
      } catch (error) {
        console.error('Load profile error:', error);
        Utils.showToast('Профайл уншихад алдаа гарлаа', 'error');
      }
    }

    // Handle avatar upload
    document.getElementById('avatarInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];

      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        Utils.showToast('Зөвхөн зураг файл оруулна уу', 'error');
        return;
      }

      // Validate file size (max 2MB for database storage)
      if (file.size > 2 * 1024 * 1024) {
        Utils.showToast('Зургийн хэмжээ 2MB-аас бага байх ёстой', 'error');
        return;
      }

      // Read and display image
      const reader = new FileReader();

      reader.onload = async function(event) {
        const imageDataUrl = event.target.result;

        try {
          // Save to database
          Utils.showToast('Зураг хадгалж байна...', 'info');
          await AuthAPI.uploadProfileImage(imageDataUrl);

          // Update avatar display
          const avatarContainer = document.getElementById('userAvatar');
          const avatarInitialsElement = document.getElementById('avatarInitials');

          // Remove existing image if any
          const existingImg = avatarContainer.querySelector('img');
          if (existingImg) {
            existingImg.remove();
          }

          // Hide initials and change background
          avatarInitialsElement.style.display = 'none';
          avatarContainer.style.background = 'none';

          // Add new image
          const img = document.createElement('img');
          img.src = imageDataUrl;
          img.alt = 'Profile Avatar';
          avatarContainer.insertBefore(img, avatarContainer.firstChild);

          Utils.showToast('Профайл зураг амжилттай солигдлоо!', 'success');

        } catch (error) {
          console.error('Error uploading profile image:', error);
          Utils.showToast('Зураг хадгалахад алдаа гарлаа: ' + error.message, 'error');
        }
      };

      reader.onerror = function() {
        Utils.showToast('Зураг уншихад алдаа гарлаа', 'error');
      };

      reader.readAsDataURL(file);
    });

    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabId) {
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));

      const targetTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
      const targetContent = document.getElementById(tabId);

      if (targetTab && targetContent) {
        targetTab.classList.add('active');
        targetContent.classList.add('active');
      }
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        switchTab(tabId);
        // Update URL hash
        window.location.hash = tabId;
      });
    });

    // Check URL hash on page load
    function checkUrlHash() {
      const hash = window.location.hash.replace('#', '');
      if (hash && ['personal', 'wallet', 'security', 'preferences'].includes(hash)) {
        switchTab(hash);
      }
    }

    // Listen for hash changes
    window.addEventListener('hashchange', checkUrlHash);

    // Load wallet and loans stats
    async function loadStats() {
      try {
        // Load wallet
        const walletResponse = await WalletAPI.getMyWallet();
        const balance = parseFloat(walletResponse.wallet.balance) || 0;
        document.getElementById('walletBalanceStat').textContent = `₮${balance.toLocaleString()}`;
        document.getElementById('walletBalanceMain').textContent = `₮${balance.toLocaleString()}`;

        // Load wallet transactions
        const transResponse = await WalletAPI.getTransactions(10);
        const transactions = transResponse.transactions || [];
        const transContainer = document.getElementById('walletTransactions');

        if (transactions.length > 0) {
          transContainer.innerHTML = transactions.map((trans, index) => {
            const date = new Date(trans.created_at).toLocaleDateString('mn-MN');
            const isCredit = trans.type === 'credit';
            const borderStyle = index < transactions.length - 1 ? 'border-bottom: 1px solid var(--line);' : '';

            return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; ${borderStyle}">
                <div>
                  <div style="font-weight: 700; margin-bottom: 4px;">${trans.description || (isCredit ? 'Орлого' : 'Зарлага')}</div>
                  <div style="font-size: 13px; color: var(--text-muted);">${date}</div>
                </div>
                <div style="font-weight: 800; font-size: 1.125rem; color: ${isCredit ? '#10b981' : '#EF4444'};">
                  ${isCredit ? '+' : '-'}₮${Math.abs(trans.amount).toLocaleString()}
                </div>
              </div>
            `;
          }).join('');
        } else {
          transContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><p>Гүйлгээ байхгүй</p></div>';
        }

        // Load loans
        const loansResponse = await LoansAPI.getMyLoans();
        const loans = Array.isArray(loansResponse) ? loansResponse : (loansResponse.loans || []);
        const activeLoans = loans.filter(l => l.status === 'disbursed' || l.status === 'active' || l.status === 'approved');
        const totalAmount = activeLoans.reduce((sum, l) => sum + parseFloat(l.amount || 0), 0);

        document.getElementById('activeLoansCount').textContent = activeLoans.length;
        document.getElementById('totalLoanAmount').textContent = `₮${totalAmount.toLocaleString()}`;

      } catch (error) {
        console.error('Load stats error:', error);
      }
    }

    // Load profile on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadProfile();
        loadStats();
        checkUrlHash();
      });
    } else {
      loadProfile();
      loadStats();
      checkUrlHash();
    }
  </script>
</body>
</html>